---
output: 
  html_document:
    includes:
      in_header: GA_Script.html
params:
  institution_name: "nothing"
  institution_long_name: "nothing"
  overview_table: "nothing"
  raw_table: "nothing"
title: "`r paste0(params$institution_long_name)`"

---

```{r, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(dev="png")
raw_table_df <- as.data.frame(params$raw_table)
focal_row_number <- which(raw_table_df$"Institution Name"==params$institution_name)
nearby <- seq(from=max(1, focal_row_number-5), to=min(nrow(raw_table_df),focal_row_number+5), by=1)
nearby_athletics <- which(raw_table_df$"NCAA/NAIA conference number cross country/track"== raw_table_df$"NCAA/NAIA conference number cross country/track"[focal_row_number])
if(length(nearby_athletics)<25) {
	#nearby <- unique(c(nearby, nearby_athletics))
	nearby <- nearby_athletics
}
focal_raw <- subset(raw_table_df, raw_table_df$"Institution Name"==params$institution_name)[1,]
focal_nearby <- raw_table_df[nearby,]
focal_nearby$Focal <- FALSE
focal_nearby$Focal[which(focal_nearby$"Institution Name"==params$institution_name)] <- TRUE
```

### General information


* `r params$overview_table['Sector']`
* `r params$overview_table['Type']`
`r paste0(ifelse(params$overview_table['Historically Black College or University']=="Yes", "* This is a historically black college or university (HBCU)", ""))`
`r paste0(ifelse(focal_raw['Tribal college']=="Yes", "* This is a tribal college", ""))`
`r ifelse(focal_raw['AAUP_Censure']=="Yes", '* **"Unsatisfactory conditions of academic freedom and tenure have been found to prevail at this institution"** according to the <a href="https://www.aaup.org/our-programs/academic-freedom/censure-list">AAUP</a>', "")`
`r ifelse(params$overview_table["Anti-LGBTQ+ state laws" ]=="Yes", '* **California considers the state this institution is in to have one or more anti-LGBTQ+ laws.** See more <a href="https://oag.ca.gov/ab1887">here</a>', "")`
* Undergraduate enrollment is `r format(as.numeric(params$overview_table["Undergraduate enrollment"]),big.mark=",", scientific=FALSE)` (includes all undergrads; some of the numbers below are based on first time, full time, degree seeking students only).
* `r ifelse(is.na(focal_raw['Mission statement (IC2019mission)']), paste0('See mission at ', focal_raw["Mission statement URL (if mission statement not provided) (IC2019mission)"]), paste0("Mission: ", focal_raw['Mission statement (IC2019mission)']))`
* `r 100*params$overview_table['Admission']`% of applicants are admitted
* `r 100*params$overview_table['Yield']`% of admitted applicants choose to enroll
* `r 100*params$overview_table['First year retention']`% of students stay after their first year
* `r 100*params$overview_table['Graduation']`% of students graduate
* The student to all faculty ratio is `r paste0(focal_raw["Student-to-faculty ratio"], ":1")`
* The student to tenured or tenure-track faculty ratio is `r paste0(round(as.numeric(params$overview_table["Students per tenure-track professor"])),":1")`
* Students `r ifelse(focal_raw['AllStudentsVaccinatedAgainstCovid19']=="Yes", "are", "are not")` required to be vaccinated against COVID-19
* Employees `r ifelse(focal_raw['AllEmployeesVaccinatedAgainstCovid19']=="Yes", "are", "are not")` required to be vaccinated against COVID-19
* This college is located in a `r tolower(paste0(rev(strsplit(as.character(params$overview_table['LocaleChar']), ': ')[[1]]), collapse=' '))`
* `r ifelse(is.na(params$overview_table['Minimum distance to mass transit (minutes walking)']), "It is not near mass transit", paste0("The closest mass transit is a ", params$overview_table['Minimum distance to mass transit (minutes walking)'], " minute walk away"))`
* As of July, 2022, the state this institution is in had abortion restrictions categorized "`r gsub("\\d\\: ", "", tolower(params$overview_table['Abortion restrictions'][1,1]))`" by the [Guttmacher Institute](https://states.guttmacher.org/policies/), though this may change.
* Athletic conference: `r focal_raw["NCAA/NAIA conference number cross country/track"]`

# Details {.tabset}

## Tables

### Degrees awarded each year

```{r, echo=FALSE, message=FALSE, warning=FALSE}
degrees <- data.frame(Degree=c("Associate", "Bachelor", "Master", "Doctor"), Number=unname(unlist(c(focal_raw["Number of students receiving an Associate's degree (DRVC2020)" ], focal_raw["Number of students receiving a Bachelor's degree (DRVC2020)" ],focal_raw["Number of students receiving a Master's degree (DRVC2020)" ],focal_raw["Number of students receiving a Doctor's degree (DRVC2020)"]))))

knitr::kable(degrees, row.names=FALSE)
```

### Diversity among the faculty

Two things to note here are diversity overall as well as the distribution tenure, tenure track, and non tenure track faculty. There are two main tracks in academia: faculty who are given short term contracts (and often a high teaching load and lower pay) and faculty who are essentially on probation (for 3-6 years, typically) and then are given tenure or fired. For more about tenure, see [here](https://www.aaup.org/issues/tenure). Tenure is a way of protecting academic freedom (tenured faculty can be fired for misconduct or if a program is closed, but not for their research or speech); the fact that it is often more stable also helps ensure that faculty will be at an institution long term to serve as mentors, letter writers, etc. Having more non-tenure-track faculty can save money (they are often paid less, and teach more), reduce public dissent (they can be fired for taking a stand unpopular with their employer), and reduce research or other creative output, including mentoring in these areas (teaching loads are often higher, and research/creative output expectations lower, for faculty in non-tenure-track positions at large universities).

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=(nrow(focal_raw)==1)}
instructor_levels <- gsub("Black or African American men ", "", colnames(focal_raw)[grepl("Black or African American men \\(Full", colnames(focal_raw))])
instructor_groups <- unique(gsub(" \\(.*\\)", "", colnames(focal_raw)[grepl("Full-time instructional", colnames(focal_raw))]))

get_level <- function(x) {
	return(unname(gsub("\\)", "", strsplit(x, "  +")[[1]][2])))
}
professional_levels <- unique(sapply(instructor_levels, get_level))
professional_levels <- professional_levels[!is.na(professional_levels)]
combinations <- expand.grid(professional_levels = professional_levels, rank=c("(Full-time instructional not on tenure/no tenure system  ", "(Full-time instructional on-tenure track  ", "(Full-time instructional tenured  "))

faculty_counts <- matrix(0, nrow=length(instructor_groups), ncol=nrow(combinations))
rownames(faculty_counts) <- instructor_groups
colnames(faculty_counts) <- paste0(combinations$rank, combinations$professional_levels, ")")
for (row_index in sequence(nrow(faculty_counts))) {
	for(col_index in sequence(ncol(faculty_counts))) {
		try(faculty_counts[row_index, col_index] <- as.numeric(focal_raw[paste0(rownames(faculty_counts)[row_index], " ", colnames(faculty_counts)[col_index])]), silent=TRUE)
	}	
}
faculty_counts[which(is.na(faculty_counts))] <- 0
#faculty_counts <- faculty_counts[,which(colSums(faculty_counts)>0)]
colnames(faculty_counts) <- gsub('\\(Full-time instructional ', '', gsub('\\)', '', colnames(faculty_counts)))

faculty_counts_summary <- as.data.frame(matrix(0, nrow=nrow(faculty_counts), ncol=6))
rownames(faculty_counts_summary) <- rownames(faculty_counts)
colnames(faculty_counts_summary) <- c("Tenured (count)", "Tenure-track (count)", "Non-tenure-track (count)", "Tenured (percent)", "Tenure-track (percent)", "Non-tenure-track (percent)")
total_faculty <- sum(sum(faculty_counts[c("Grand total men", "Grand total women"),]))
faculty_counts_summary[,4:6] <- as.character(faculty_counts_summary[,4:6])
# tenured
matching_cols <- which(grepl("tenured", colnames(faculty_counts)))
for (row_index in sequence(nrow(faculty_counts_summary))) {
  if(length(matching_cols)>=1) {
  	faculty_counts_summary[row_index,1] <- sum(faculty_counts[row_index,matching_cols])
  	faculty_counts_summary[row_index,4] <- paste0(100*round(faculty_counts_summary[row_index,1]/total_faculty,3), "%")
  }
}
# tt
matching_cols <- which(grepl("on-tenure", colnames(faculty_counts)))
for (row_index in sequence(nrow(faculty_counts_summary))) {
  if(length(matching_cols)>=1) {
  	faculty_counts_summary[row_index,2] <- sum(faculty_counts[row_index,matching_cols])
  	faculty_counts_summary[row_index,5] <- paste0(100*round(faculty_counts_summary[row_index,2]/total_faculty,3), "%")
  }
}
# ntt
matching_cols <- which(grepl("no tenure", colnames(faculty_counts)))
for (row_index in sequence(nrow(faculty_counts_summary))) {
  if(length(matching_cols)>=1) {
  	faculty_counts_summary[row_index,3] <- sum(faculty_counts[row_index,matching_cols])
  	faculty_counts_summary[row_index,6] <- paste0(100*round(faculty_counts_summary[row_index,3]/total_faculty,3), "%")
  }
}

knitr::kable(faculty_counts_summary, row.names=TRUE)
```

### Diversity among the students

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=(nrow(focal_raw)==1)}
student_demographics <- gsub(" \\(EF2019A_RV  Full-time students  Undergraduate total\\)", "", colnames(focal_raw)[grepl("(EF2019A_RV  Full-time students  Undergraduate total)", colnames(focal_raw))])


student_types <- c("(EF2019A_RV  Full-time students  Undergraduate total)", "(EF2019A_RV  Full-time students  Graduate)")

combinations <- expand.grid(student_demographics = student_demographics, rank=student_types)


student_counts <- as.data.frame(matrix(0, nrow=length(student_demographics), ncol=length(student_types)))
rownames(student_counts) <- student_demographics
colnames(student_counts) <-student_types
for (row_index in sequence(nrow(student_counts))) {
	for(col_index in sequence(ncol(student_counts))) {
		try(student_counts[row_index, col_index] <- as.numeric(focal_raw[paste0(rownames(student_counts)[row_index], " ", colnames(student_counts)[col_index])]), silent=TRUE)
		if(is.na(student_counts[row_index, col_index])) {
			student_counts[row_index, col_index] <- 0	
		}
	}	
}

total_undergrads <- student_counts[1,1] + student_counts[2,1]
total_grads <- student_counts[1,2] + student_counts[2,2]
colnames(student_counts) <- c("Undergrad (count)", "Grad student (count)")
student_counts$`Undergrads (percent)` <- "0%"
student_counts$`Grad students (percent)` <- "0%"
for (i in sequence(nrow(student_counts))) {
	student_counts[i,3] <- paste0(round(100*student_counts[i,1]/total_undergrads,1), '%')
	student_counts[i,4] <- paste0(round(100*student_counts[i,2]/total_grads,1), '%')

}

knitr::kable(student_counts, row.names=TRUE)
```

### US student origins

First time degree seeking undergrads

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=(nrow(focal_raw)==1)}
Students_by_state <- data.frame(fips=rep(NA,  length(state.name)), abbr=state.abb, State=state.name, Undergrad_Count=rep(0.0, length(state.name)), Percent_of_18_yo_from_this_state_enrolled_here=rep(0.0, length(state.name)))

state_pops <- GetPopulationByStateAtAge18()

for (i in sequence(nrow(Students_by_state))) {
	Students_by_state$Undergrad_Count[i] <- unname(unlist(focal_raw[paste0("Count of first-time undergrads from ", Students_by_state$State[i])]))
	Students_by_state$Percent_of_18_yo_from_this_state_enrolled_here[i] <- unname(unlist(focal_raw[paste0("Percentage of all 18 year olds in the focal state enrolling in this college from ", Students_by_state$State[i])]))
	if(is.na(Students_by_state$Undergrad_Count[i])) {
		Students_by_state$Undergrad_Count[i] <- 0
		Students_by_state$Percent_of_18_yo_from_this_state_enrolled_here[i] <- 0
	}
	Students_by_state$fips[i] <- state_pops$State_FIPS[which(state_pops$State==Students_by_state$State[i])]
}
count_data <- as.data.frame(select(Students_by_state, c("fips", "Undergrad_Count")))
colnames(count_data) <- c("fips", "values")
count_data$fips <- as.character(count_data$fips)
count_data$values[is.na(count_data$values)] <- 0
count_data[,2] <- as.numeric(count_data[,2])

pretty_table <- Students_by_state[, c('State','Undergrad_Count')]
colnames(pretty_table) <- c("State", "Number of students")
pretty_table$'Fraction of student body from each state' <- paste0('1/',round(sum(as.numeric(pretty_table$'Number of students'))/as.numeric(pretty_table$'Number of students')))
pretty_table$'Fraction of student body from each state' <- gsub('1/Inf', '0', pretty_table$'Fraction of student body from each state')
pretty_table$'Fraction of 18 year olds from each state enrolled here' <- paste0('1/',round(100/Students_by_state$Percent_of_18_yo_from_this_state_enrolled_here))
pretty_table$'Fraction of 18 year olds from each state enrolled here' <- gsub('1/Inf', '0', pretty_table$'Fraction of 18 year olds from each state enrolled here')

```

`r ifelse((max(count_data$values))==0, "**There are no available data on states of origin**", "")`

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=(nrow(focal_raw)==1)}

if(max(count_data$values)>0) {

  knitr::kable(pretty_table, row.names=FALSE)
  
  #plot_usmap(data=count_data, regions = "states", color = "blue") + labs(title=paste0("Number of students from each #state enrolled in ",params$institution_name)) +
  #  scale_fill_continuous(low = "white", high = "blue", name = "Number of undergrads", label = scales::comma) +  theme(legend.position = "right")
} 

pct_data <- select(Students_by_state, c("fips", "Percent_of_18_yo_from_this_state_enrolled_here"))
colnames(pct_data) <- c("fips", "values")
pct_data$fips <- as.character(pct_data$fips)
pct_data$values <- as.numeric(pct_data$values)


```



### Library resources

```{r, echo=FALSE, message=FALSE, warning=FALSE}

library_columns <- c("Number of physical books", "Number of physical media"  ,  "Number of physical serials" , "Number of digital/electronic books", "Number of digital/electronic databases", "Number of digital/electronic media", "Number of electronic serials" , "Total library collections (physical and electronic)" , "Total physical library circulations (books and media)", "Total digital/electronic circulations (books and media)", "Total library circulations (physical and digital/electronic)" , "Total interlibrary loans and documents provided to other libraries", "Total interlibrary loans and documents received" )                 
library_table <- as.data.frame( t(focal_raw[library_columns]))
colnames(library_table) <- "Number"
library_table$Number <- as.numeric(library_table$Number )
library_table$`Number per undergrad` <- ceiling(library_table$Number/as.numeric(params$overview_table["Undergraduate enrollment"]))
library_table[5,2] <- library_table[5,1]
library_table$Number <- format(as.numeric(library_table$Number),big.mark=",", scientific=FALSE)
library_table$`Number per undergrad` <- format(as.numeric(library_table$`Number per undergrad`),big.mark=",", scientific=FALSE)

knitr::kable(library_table)
```

## Figures


### Student to faculty ratio compared to similar institutions:

```{r, echo=FALSE, message=FALSE, warning=FALSE}
df_to_plot <- focal_nearby[,c('Institution Name', "Student-to-faculty ratio", 'StudentToTenureTrackRatio', 'Focal')]
colnames(df_to_plot) <- c("Institution", "StudentsToAllFaculty", "StudentsToTTFaculty", "Focal")
df_to_plot[,2] <- as.numeric(df_to_plot[,2])
df_to_plot[,3] <- as.numeric(df_to_plot[,3])
print(
	ggplot(df_to_plot, aes(x=StudentsToAllFaculty, y=StudentsToTTFaculty, label=Institution, colour=Focal)) +
	geom_point() + geom_text_repel() + xlab("Students per instructor (lower is better)") + ylab("Students per tenure track instructor (lower is better)") + theme_minimal() + scale_color_manual(labels = c("darkgray", "red"), values=c("darkgray", "red")) + theme(legend.position = "none")
	)
```

### Students from US

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=(nrow(focal_raw)==1)}

if(max(count_data$values)>0) {

  
  plot_usmap(data=count_data, regions = "states", color = "black") + labs(title=paste0("Number of students from each state enrolled in ",params$institution_name)) +
    scale_fill_continuous(low = "white", high = "red", name = "Number of undergrads", label = scales::comma) +  theme(legend.position = "right")
} 


if(max(pct_data$values)>0) {
	plot_usmap(data=pct_data, regions = "states", color = "black") + labs(title=paste0("Percentage of 18 year olds in each state enrolled in ",params$institution_name)) +
  	scale_fill_continuous(low = "white", high = "red", name = "Percentage (out of 100)", label = scales::comma) +  theme(legend.position = "right")
} 
```