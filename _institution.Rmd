---
output:
  html_document:
    self_contained: false
    includes:
      in_header: GA_Script.html
params:
  institution_name: "nothing"
  institution_long_name: "nothing"
  overview_table: "nothing"
  raw_table: "nothing"
  students_by_state_by_institution: "nothing"
  student_demographics: "nothing"
  faculty_counts: "nothing"
title: "`r paste0(params$institution_long_name)`"

---

```{r, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(dev="png")
raw_table_df <- as.data.frame(params$raw_table)
students_by_state <- params$students_by_state_by_institution[[params$institution_name]]
student_demographics_focal <- params$student_demographics[[params$institution_name]]
faculty_counts_focal <- params$faculty_counts[[params$institution_name]]
focal_row_number <- which(raw_table_df$"ShortName"==params$institution_name)
raw_table_df$FocalInstitution <- FALSE
raw_table_df$FocalInstitution[focal_row_number] <- TRUE

raw_table_df <- dplyr::rename(raw_table_df, `Associates degrees awarded`="Number of students receiving an Associate's degree (DRVC2020)", `Bachelors degrees awarded`="Number of students receiving a Bachelor's degree (DRVC2020)", `Masters degrees awarded`="Number of students receiving a Master's degree (DRVC2020)", `Doctorates awarded`="Number of students receiving a Doctor's degree (DRVC2020)")
raw_table_df$`Average library loans (physical + digital) per student or faculty member` <- round(as.numeric(raw_table_df$`Total library circulations (physical and digital/electronic)`) / as.numeric(raw_table_df$`Students plus Faculty`),1)
raw_table_df$`Average library loans (physical) per student or faculty member` <- round(as.numeric(raw_table_df$`Total physical library circulations (books and media)`) / as.numeric(raw_table_df$`Students plus Faculty`),1)


# Getting sets of colleges to compare this with

comparison_list <- list(
	comparison_athletics = subset(raw_table_df, raw_table_df$"NCAA/NAIA conference number cross country/track"==raw_table_df$"NCAA/NAIA conference number cross country/track"[focal_row_number]),
	comparison_type = subset(raw_table_df, raw_table_df$Type==raw_table_df$Type[focal_row_number]),
	comparison_sector = subset(raw_table_df, raw_table_df$Sector==raw_table_df$Sector[focal_row_number])
)

focal_raw <- subset(raw_table_df, raw_table_df$"ShortName"==params$institution_name)[1,]

total_undergrads <- unlist(focal_raw['Undergraduate enrollment'])
total_grads <- unlist(focal_raw['Graduate enrollment'])
```

`r ifelse(focal_raw['AAUP_Censure']=="Yes", '<h2 style="color:Red;"> **Warning: "Unsatisfactory conditions of academic freedom and tenure have been found to prevail at this institution"** according to the <a href="https://www.aaup.org/our-programs/academic-freedom/censure-list">AAUP</a> (as of July 31, 2022)</h2>', "")`

`r ifelse(focal_raw["Anti-LGBTQ+ state laws" ]=="Yes", '<h2 style="color:Red;"> **Warning: California considers the state this institution is in to have one or more anti-LGBTQ+ laws** (as of July 31, 2022). See more <a href="https://oag.ca.gov/ab1887">here</a></h2>', "")`


```{r, echo=FALSE, message=FALSE, warning=FALSE}
fields_to_compare <- c(
	"Admission", "Yield", 
	"First year retention", 
	"Graduation", 
	"Undergraduate enrollment", 
	"Graduate enrollment", 
	"Associates degrees awarded", 
	"Bachelors degrees awarded", 
	"Masters degrees awarded", 
	"Doctorates awarded",
	"Undergrads per instructor", 
	"Undergrads per tenure-track professor",
	"Number of physical books", 
	"Number of physical media", 
	"Number of digital/electronic books",
	"Total library collections (physical and electronic)",
	"Total library circulations (physical and digital/electronic)",
	"Average library loans (physical) per student or faculty member",
	"Average library loans (physical + digital) per student or faculty member",
	"Proportion of reps voting in favor of respect for right to contraception act",
	"Proportion of reps voting in favor of respect for marriage act"
	)
comparison_df <- data.frame(matrix("", nrow=length(fields_to_compare), ncol=1+length(comparison_list)))
rownames(comparison_df) <- fields_to_compare
colnames(comparison_df) <- c(
	as.character(params$institution_name), 
	as.character(focal_raw["NCAA/NAIA conference number cross country/track"]), 
	gsub(': ', '<br />', as.character(focal_raw['Type'])),
	gsub(', ', '<br />', as.character(focal_raw[1,'Sector'])) 
)
for (field_index in seq_along(fields_to_compare)) {
	focal_field <- fields_to_compare[field_index]
	values_for_range <- as.numeric(raw_table_df[,focal_field])
	values_for_range <- values_for_range[is.finite(values_for_range)]
	focal_field_range <- range(values_for_range, na.rm=TRUE)
	comparison_df[field_index,1] <- as.numeric(focal_raw[focal_field])
	for (list_index in sequence(length(comparison_list))) {
		current_values <- as.numeric((comparison_list[[list_index]])[,focal_field])
		current_values <- current_values[is.finite(current_values)]
		#p <- ggplot(data=data.frame(y='1', x=current_values), aes(x=x, fill=y)) + geom_density() + theme_void() + theme(legend.position="none") + scale_fill_manual(values=c("darkgray")) + geom_vline(xintercept=as.numeric(focal_raw[focal_field]), color="red", size=2)

		p <- ggplot(data=data.frame(x='1', y=current_values), aes(x=x, y=y, fill=x)) + geom_violin() + theme_void() + theme(legend.position="none") + scale_fill_manual(values=c("darkgray")) + geom_hline(yintercept=as.numeric(focal_raw[focal_field]), color="red", size=2) + coord_flip()
		if(max(values_for_range)>1) {
			p <- p+scale_y_continuous(trans='log10') # for ease of seeing
		}

		filename_png <- paste0("images/", utils::URLencode(gsub(" ", "", params$institution_name)), "_", field_index, "_", list_index, ".png")
        ggsave(
          plot = p,
          filename = paste0('docs/', filename_png),
          bg = "transparent",
          width = 200,
          height= 35,
          units = "px"
        )

		#comparison_df[3,3] <- paste0("<img src=", filename_png, " width=40 height=5>")
		# comparison_df[field_index,list_index+1] <- median(as.numeric((comparison_list[[list_index]])[,focal_field]), na.rm=TRUE)
		comparison_df[field_index,list_index+1] <- paste0("<img src=", filename_png, " width=40 height=7>")
	}
}
if(colnames(comparison_df)[2]=="Not applicable") { # no athletics to compare with
	comparison_df <- comparison_df[,-2]
}

comparison_df[,1] <- as.character(comparison_df[,1])
for(row_index in sequence(nrow(comparison_df))) {
	try({
		if(as.numeric(comparison_df[row_index,1]) >= 1000) {
			comparison_df[row_index,1] <- format(round(as.numeric(comparison_df[row_index,1]),0),big.mark=",", scientific=FALSE)

		}
	}, silent=TRUE)
}

# p <- ggplot(data=data.frame(focal=c(TRUE, FALSE), percent=c(6, 100-6), x=c(1,1)), aes(fill=focal, y=percent, x=x)) + geom_bar(position="fill", stat="identity") +  theme_void() + theme(legend.position="none") + coord_flip() + scale_fill_manual(values=c("darkgray", "red")) 
#p <- ggplot(data=data.frame(y='1', x=as.numeric(comparison_list[[1]][,'Undergraduate enrollment'])), aes(x=x, fill=y)) + geom_density() + theme_void() + theme(legend.position="none") + scale_fill_manual(values=c("black"))



colnames(comparison_df) <- paste0('&nbsp;&nbsp;',colnames(comparison_df), '&nbsp;&nbsp;')
comparison_df %>% addHtmlTableStyle(col.rgroup = c("none", "#F7F7F7")) %>% htmlTable::htmlTable(escape.html=TRUE)
```


### Other information

```{r, echo=FALSE, message=FALSE, warning=FALSE}
state_summary <- data.frame(matrix(nrow=0, ncol=2))
colnames(state_summary) <- c("Measure", "Value")
if(focal_raw["Anti-LGBTQ+ state laws" ]=="Yes") {
	state_summary[nrow(state_summary)+1,] <- c('Warning', '**California considers the state this institution is in to have one or more anti-LGBTQ+ laws.** See more <a href="https://oag.ca.gov/ab1887">here</a>')
}

if(focal_raw['AAUP_Censure']=="Yes") {
	state_summary[nrow(state_summary)+1,] <- c('Warning', '**"Unsatisfactory conditions of academic freedom and tenure have been found to prevail at this institution"** according to the <a href="https://www.aaup.org/our-programs/academic-freedom/censure-list">AAUP</a>')
}

if(focal_raw['Historically Black College or University']=="Yes") {
	state_summary[nrow(state_summary)+1,] <- c('Historically Black College or University', "Yes")
}
if(focal_raw['Tribal college']=="Yes") {
	state_summary[nrow(state_summary)+1,] <- c('Tribal College', "Yes")
}


state_summary[nrow(state_summary)+1,] <- c("Employee covid vax", ifelse(focal_raw['Covid vax (employees)']=="Yes", "Required", "Not required"))

state_summary[nrow(state_summary)+1,] <- c("Student covid vax", ifelse(focal_raw['Covid vax (students)']=="Yes", "Required", "Not required"))

state_summary %>% htmlTable::htmlTable(rnames=FALSE)
```

`r paste0(ifelse(focal_raw['Historically Black College or University']=="Yes", "* This is a historically black college or university (HBCU)", ""))`
`r paste0(ifelse(focal_raw['Tribal college']=="Yes", "* This is a tribal college", ""))`

`r ifelse(focal_raw["Anti-LGBTQ+ state laws" ]=="Yes", '* **California considers the state this institution is in to have one or more anti-LGBTQ+ laws.** See more <a href="https://oag.ca.gov/ab1887">here</a>', "")`
* Students `r ifelse(focal_raw['Covid vax (students)']=="Yes", "are", "are not")` required to be vaccinated against COVID-19
* Employees `r ifelse(focal_raw['Covid vax (employees)']=="Yes", "are", "are not")` required to be vaccinated against COVID-19
* This college is located in a `r tolower(paste0(rev(strsplit(as.character(focal_raw['LocaleChar']), ': ')[[1]]), collapse=' '))`: `r as.character(focal_raw['City'])`,  `r as.character(focal_raw['State'][1,1])`
* `r ifelse(is.na(focal_raw['Minimum distance to mass transit (minutes walking)']), "It is not near mass transit", paste0("The closest mass transit is a ", focal_raw['Minimum distance to mass transit (minutes walking)'], " minute walk away"))`
* As of August 8, 2022, abortion is `r tolower(focal_raw['Abortion'][1,1])` in this state, though this may change.
* The ecology where this college is located is `r as.character(focal_raw['eco_name'][1,1])`, in the `r tolower(as.character(focal_raw['biome'][1,1]))` biome.
* The gun law stringency of this state is `r focal_raw['Gun law stringency'][1,1]`.

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}
leaflet() %>%
  addTiles() %>%  
  setView(lng = as.numeric(focal_raw['longitude']), lat = as.numeric(focal_raw['latitude']), zoom = 16) %>% 
  addMarkers(lng=as.numeric(focal_raw['longitude']), lat=as.numeric(focal_raw['latitude']), popup=params$institution_name)
```




```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
degrees <- data.frame(Degree=c("Associate", "Bachelor", "Master", "Doctor"), Number=unname(unlist(c(focal_raw["Number of students receiving an Associate's degree (DRVC2020)" ], focal_raw["Number of students receiving a Bachelor's degree (DRVC2020)" ],focal_raw["Number of students receiving a Master's degree (DRVC2020)" ],focal_raw["Number of students receiving a Doctor's degree (DRVC2020)"]))))


degrees %>% htmlTable::htmlTable(rnames=FALSE)

```

### Diversity among the faculty

Two things to note here are diversity overall as well as the distribution tenure, tenure track, and non tenure track faculty. There are two main tracks in academia: faculty who are given short term contracts (and often a high teaching load and lower pay) and faculty who are essentially on probation (for 3-6 years, typically) and then are given tenure or fired. For more about tenure, see [here](https://www.aaup.org/issues/tenure). Tenure is a way of protecting academic freedom (tenured faculty can be fired for misconduct or if a program is closed, but not for their research or speech); the fact that it is often more stable also helps ensure that faculty will be at an institution long term to serve as mentors, letter writers, etc. Having more non-tenure-track faculty can save money (they are often paid less, and teach more), reduce public dissent (they can be fired for taking a stand unpopular with their employer), and reduce research or other creative output, including mentoring in these areas (teaching loads are often higher, and research/creative output expectations lower, for faculty in non-tenure-track positions at large universities).

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=(nrow(focal_raw)==1)}
faculty_counts_focal_streamlined <- data.frame(matrix("", nrow=nrow(faculty_counts_focal)/2, ncol=6))
rownames(faculty_counts_focal_streamlined) <- gsub(" women", "", rownames(faculty_counts_focal)[which(grepl("women", rownames(faculty_counts_focal)))])
faculty_counts_focal$TenureStreamCount <- as.numeric(faculty_counts_focal$`Tenured (count)`) + as.numeric(faculty_counts_focal$`Tenure-track (count)`)
faculty_trimmed <- faculty_counts_focal %>% select('TenureStreamCount', 'Non-tenure-track (count)')
for (faculty_row_index in sequence(nrow(faculty_counts_focal_streamlined))) {
    faculty_counts_focal_streamlined[faculty_row_index, 1] <- faculty_trimmed[paste0(rownames(faculty_counts_focal_streamlined)[faculty_row_index], " women"), 1]
    faculty_counts_focal_streamlined[faculty_row_index, 2] <- faculty_trimmed[paste0(rownames(faculty_counts_focal_streamlined)[faculty_row_index], " men"), 1]
	faculty_counts_focal_streamlined[faculty_row_index, 3] <- round(100*(as.numeric(faculty_counts_focal_streamlined[faculty_row_index, 1])+as.numeric(faculty_counts_focal_streamlined[faculty_row_index, 2]))/(as.numeric(faculty_counts_focal_streamlined["Grand total", 1])+as.numeric(faculty_counts_focal_streamlined["Grand total", 2])))
	percentage <- round(as.numeric(faculty_counts_focal_streamlined[faculty_row_index, 3]))
	faculty_counts_focal_streamlined[faculty_row_index, 3] <- paste0("<img src=images/pct_bar_", percentage, ".png width=40 height=5>")
	
    faculty_counts_focal_streamlined[faculty_row_index, 4] <- faculty_trimmed[paste0(rownames(faculty_counts_focal_streamlined)[faculty_row_index], " women"), 2]
    faculty_counts_focal_streamlined[faculty_row_index, 5] <- faculty_trimmed[paste0(rownames(faculty_counts_focal_streamlined)[faculty_row_index], " men"), 2]
	faculty_counts_focal_streamlined[faculty_row_index, 6] <- round(100*(as.numeric(faculty_counts_focal_streamlined[faculty_row_index, 4])+as.numeric(faculty_counts_focal_streamlined[faculty_row_index, 5]))/(as.numeric(faculty_counts_focal_streamlined["Grand total", 4])+as.numeric(faculty_counts_focal_streamlined["Grand total", 5])))
	percentage <- round(as.numeric(faculty_counts_focal_streamlined[faculty_row_index, 6]))
	faculty_counts_focal_streamlined[faculty_row_index, 6] <- paste0("<img src=images/pct_bar_", percentage, ".png width=40 height=5>")
	
}
colnames(faculty_counts_focal_streamlined) <- c("Women", "Men", "%", "Women", "Men", "%")
faculty_counts_focal_streamlined <- rbind(faculty_counts_focal_streamlined, faculty_counts_focal_streamlined["Grand total",])[-1,]
rownames(faculty_counts_focal_streamlined)[nrow(faculty_counts_focal_streamlined)] <- "Total"
faculty_counts_focal_streamlined["Total", 3] <- ""
faculty_counts_focal_streamlined["Total", 6] <- ""



faculty_counts_focal_streamlined %>% addHtmlTableStyle(col.rgroup = c("none", "#F7F7F7")) %>% htmlTable::htmlTable(cgroup = c("Tenure Stream", "Non-Tenure Track"), n.cgroup = c(3,3), total=TRUE, escape.html=TRUE)

#knitr::kable(faculty_counts_focal, row.names=TRUE)

```

### Diversity among the students

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

# try(knitr::kable(student_demographics_focal, row.names=TRUE))
student_demographics_focal_streamlined <- data.frame(matrix("", nrow=nrow(student_demographics_focal)/2, ncol=6))
rownames(student_demographics_focal_streamlined) <- gsub(" women", "", rownames(student_demographics_focal)[which(grepl("women", rownames(student_demographics_focal)))])
student_trimmed <- student_demographics_focal %>% select('Undergrad (count)', 'Grad student (count)')
for (student_row_index in sequence(nrow(student_demographics_focal_streamlined))) {
    student_demographics_focal_streamlined[student_row_index, 1] <- student_trimmed[paste0(rownames(student_demographics_focal_streamlined)[student_row_index], " women"), 1]
    student_demographics_focal_streamlined[student_row_index, 2] <- student_trimmed[paste0(rownames(student_demographics_focal_streamlined)[student_row_index], " men"), 1]
	student_demographics_focal_streamlined[student_row_index, 3] <- round(100*(as.numeric(student_demographics_focal_streamlined[student_row_index, 1])+as.numeric(student_demographics_focal_streamlined[student_row_index, 2]))/(as.numeric(student_demographics_focal_streamlined["Grand total", 1])+as.numeric(student_demographics_focal_streamlined["Grand total", 2])))
	percentage <- round(as.numeric(student_demographics_focal_streamlined[student_row_index, 3]))
	if(!is.finite(percentage)) { 
		percentage <- 0
	}
	student_demographics_focal_streamlined[student_row_index, 3] <- paste0("<img src=images/pct_bar_", percentage, ".png width=40 height=5>")
	
    student_demographics_focal_streamlined[student_row_index, 4] <- student_trimmed[paste0(rownames(student_demographics_focal_streamlined)[student_row_index], " women"), 2]
    student_demographics_focal_streamlined[student_row_index, 5] <- student_trimmed[paste0(rownames(student_demographics_focal_streamlined)[student_row_index], " men"), 2]
	student_demographics_focal_streamlined[student_row_index, 6] <- round(100*(as.numeric(student_demographics_focal_streamlined[student_row_index, 4])+as.numeric(student_demographics_focal_streamlined[student_row_index, 5]))/(as.numeric(student_demographics_focal_streamlined["Grand total", 4])+as.numeric(student_demographics_focal_streamlined["Grand total", 5])))
	percentage <- round(as.numeric(student_demographics_focal_streamlined[student_row_index, 6]))
	if(!is.finite(percentage)) { 
		percentage <- 0
	}
	student_demographics_focal_streamlined[student_row_index, 6] <- paste0("<img src=images/pct_bar_", percentage, ".png width=40 height=5>")
	
}
colnames(student_demographics_focal_streamlined) <- c("Women", "Men", "%", "Women", "Men", "%")
student_demographics_focal_streamlined <- rbind(student_demographics_focal_streamlined, student_demographics_focal_streamlined["Grand total",])[-1,]
rownames(student_demographics_focal_streamlined)[nrow(student_demographics_focal_streamlined)] <- "Total"
student_demographics_focal_streamlined["Total", 3] <- ""
student_demographics_focal_streamlined["Total", 6] <- ""



student_demographics_focal_streamlined %>% addHtmlTableStyle(col.rgroup = c("none", "#F7F7F7")) %>% htmlTable::htmlTable(cgroup = c("Undergrads", "Grad students"), n.cgroup = c(3,3), total=TRUE, escape.html=TRUE)

```




```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}

count_data <- data.frame(fips=students_by_state$fips, values=as.numeric(students_by_state$`Number of students`))
if(max(count_data$values)>0) {
  plot_usmap(data=count_data, regions = "states", color = "black") + labs(title=paste0("Number of students from each state enrolled in ",params$institution_name)) +
    scale_fill_continuous(low = "white", high = "red", name = "Number of undergrads", label = scales::comma) +  theme(legend.position = "right")
	
	 plot_usmap(data=count_data, regions = "states", color = "black") + labs(title=paste0("Number of students from each state enrolled in ","test")) +
    scale_fill_continuous(low = "white", high = "red", name = "Number of undergrads", label = scales::comma) +  theme(legend.position = "right")
} 


if(max(count_data$values)>0) {
	pct_data <- data.frame(fips=students_by_state$fips, values=CharacterFractionToNumeric(students_by_state$`Fraction of 18 year olds from each state enrolled here`))

	plot_usmap(data=pct_data, regions = "states", color = "black") + labs(title=paste0("Percentage of 18 year olds in each state enrolled in ",params$institution_name)) +
  	scale_fill_continuous(low = "white", high = "red", name = "Percentage (out of 100)", label = scales::comma) +  theme(legend.position = "right")
} 
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

students_by_state$`Percentage of 18 year olds from each state enrolled here` <- 100*CharacterFractionToNumeric(students_by_state$`Fraction of 18 year olds from each state enrolled here`)

students_by_state$`Number of students` <- as.numeric(students_by_state$`Number of students`)

# kable(students_by_state)

if(max(students_by_state$`Number of students`)>0) {
 g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  lakecolor = toRGB('white')
   )
   
   StudentNumbers <- as.numeric(students_by_state$`Number of students`)
   names(StudentNumbers) <- students_by_state$State
   plot_geo() %>%
  add_trace(
    z = ~StudentNumbers, text = state.name, span = I(0),
    locations = state.abb, locationmode = 'USA-states', colors = 'Purples'
  ) %>% colorbar(title = "Number of students") %>% 
  layout(geo = g, title="")
  
} 


```



```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}


if(max(students_by_state$`Number of students`)>0) {
 
    StudentPercentage <- students_by_state$`Percentage of 18 year olds from each state enrolled here`
   names(StudentPercentage) <- students_by_state$State
   plot_geo() %>%
  add_trace(
    z = ~StudentPercentage, text = state.name, span = I(0),
    locations = state.abb, locationmode = 'USA-states', colors = 'Purples'
  ) %>%  colorbar(title = "Percent") %>%
  layout(geo = g, title="Rough percentage of 18 year olds in each state attending this college")
} 


```


```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}

#if(max(count_data$values)>0) {
  
  #students_by_state[,-1] %>% addHtmlTableStyle(col.rgroup = c("none", "#F7F7F7")) %>% htmlTable::htmlTable()
 #try(knitr::kable(students_by_state[,-1], row.names=FALSE))

#} 

# pct_data <- select(Students_by_state, c("fips", "Percent_of_18_yo_from_this_state_enrolled_here"))
# colnames(pct_data) <- c("fips", "values")
# pct_data$fips <- as.character(pct_data$fips)
# pct_data$values <- as.numeric(pct_data$values)


```




```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}

library_columns <- c("Number of physical books", "Number of physical media"  ,  "Number of physical serials" , "Number of digital/electronic books", "Number of digital/electronic databases", "Number of digital/electronic media", "Number of electronic serials" , "Total library collections (physical and electronic)" , "Total physical library circulations (books and media)", "Total digital/electronic circulations (books and media)", "Total library circulations (physical and digital/electronic)" , "Total interlibrary loans and documents provided to other libraries", "Total interlibrary loans and documents received" )                 
library_table <- as.data.frame( t(focal_raw[library_columns]))
colnames(library_table) <- "Number"

library_table$Number <- as.numeric(library_table$Number )
library_table$`Number per students and faculty` <- round(library_table$Number/as.numeric(unlist(focal_raw["Students plus Faculty"])),1)
library_table[5,2] <- library_table[5,1]
library_table$Number <- format(as.numeric(library_table$Number),big.mark=",", scientific=FALSE)
library_table$`Number per students and faculty` <- format(as.numeric(library_table$`Number per students and faculty`),big.mark=",", scientific=FALSE)

knitr::kable(library_table)
```



```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
df_to_plot <- focal_nearby[,c('Name', "Undergrads per instructor", 'Undergrads per tenure-track professor', 'Focal')]
colnames(df_to_plot) <- c("Institution", "StudentsToAllFaculty", "StudentsToTTFaculty", "Focal")
df_to_plot[,2] <- as.numeric(df_to_plot[,2])
df_to_plot[,3] <- as.numeric(df_to_plot[,3])
p <- (
	ggplot(df_to_plot, aes(x=StudentsToAllFaculty, y=StudentsToTTFaculty, label=Institution, colour=Focal)) +
	geom_point() + geom_text_repel() + xlab("Students per instructor (lower is better)") + ylab("Students per tenure track instructor (lower is better)") + theme_minimal() + scale_color_manual(labels = c("darkgray", "red"), values=c("darkgray", "red")) + theme(legend.position = "none")
	)
	
ggplotly(p) 
```



```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
### Admissions to graduation

# This is per year, based on the number of bachelor's degrees awarded and graduation rate.

life_stages <- c("Applied", "Admitted", "Enrolled", "Retained after year 1", "Graduated")
graduation <- as.numeric(focal_raw["Number of students receiving a Bachelor's degree (DRVC2020)" ])
enrollment <- graduation/as.numeric(focal_raw['Graduation'])
retained <- enrollment*focal_raw['First year retention'] # this is an approximation
admitted<- enrollment/focal_raw['Yield']
applied <- (enrollment/focal_raw['Yield'])/focal_raw['Admission']
all_numbers <- round(unname(unlist(c(applied, admitted, enrollment, retained, graduation))))
fig <- plot_ly() 
fig <- fig %>%
  add_trace(
  type = "funnel",
  y = life_stages,
  x = all_numbers,
  textinfo="value+percent previous") 
fig <- fig %>%
  layout(yaxis = list(categoryarray = life_stages))

fig 
```

