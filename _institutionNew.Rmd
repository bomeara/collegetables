---
output:
  rmdformats::downcute:
    downcute_theme: "chaos"
    self_contained: false
    includes:
      in_header: GA_Script.html
params:
  institution_name: "nothing"
  institution_long_name: "nothing"
  institution_id: "nothing"
  comparison_table: "nothing"
  spark_width: 40
  spark_height: 5
title: "`r paste0(params$institution_name)`"

---

```{r, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(dev="png")
source("_packages.R")
source("R/functions.R")



#`UNITID Unique identification number of the institution`

focal_conference <- FirstNaOmit((subset(comparison_table, comparison_table$`UNITID Unique identification number of the institution`==params$institution_id))$`NCAA NAIA conference number cross country track`)

focal_classification <- FirstNaOmit((subset(comparison_table, comparison_table$`UNITID Unique identification number of the institution`==params$institution_id))$`Carnegie Classification 2021 Basic`)

conference_UNITID <- unique(subset(comparison_table, comparison_table$`NCAA NAIA conference number cross country track`==focal_conference)$`UNITID Unique identification number of the institution`)
conference_UNITID <- conference_UNITID[conference_UNITID!=params$institution_id]

classification_UNITID <- unique(subset(comparison_table, comparison_table$`Carnegie Classification 2021 Basic`==focal_classification)$`UNITID Unique identification number of the institution`)
classification_UNITID <- classification_UNITID[classification_UNITID!=params$institution_id]

focal_conference <- subset(comparison_table, comparison_table$`UNITID Unique identification number of the institution` %in% conference_UNITID)
focal_conference_name <- subset(comparison_table, comparison_table$`UNITID Unique identification number of the institution` %in% conference_UNITID)$`NCAA NAIA conference number cross country track`[1]

focal_conference$Comparison = "Conference"

focal_classification <- subset(comparison_table, comparison_table$`UNITID Unique identification number of the institution` %in% classification_UNITID)
focal_classification_name <- subset(comparison_table, comparison_table$`UNITID Unique identification number of the institution` %in% classification_UNITID)$`Carnegie Classification 2021 Basic`[1]
focal_classification$Comparison = "Classification"

focal_focal <- subset(comparison_table, comparison_table$`UNITID Unique identification number of the institution`==params$institution_id)
focal_focal$Comparison = "Focal"

focal_table <- dplyr::bind_rows(focal_focal, focal_conference, focal_classification)
focal_table$`IPEDS Year` <- as.numeric(focal_table$`IPEDS Year`)
focal_table <- focal_table[order(focal_table$`IPEDS Year`, decreasing=TRUE),]

most_current_info <- apply(focal_focal, 2, FirstNaOmit)


#chief_admins <- humaniformat::last_name(focal_focal$`Name of chief administrator`)

```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
comparison_conversions <- read.csv("data/ConversionToSummaryCharts.csv")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

comparison_vector <- c("Conference", "Classification")
headings <- unique(comparison_conversions$Category)
comparison_df <- data.frame(matrix("", nrow=nrow(comparison_conversions), ncol=4+length(comparison_vector)))
colnames(comparison_df) <- c(params$institution_name, "Change", "Over time", focal_conference_name, focal_classification_name, "Heading")
rownames(comparison_df) <- comparison_conversions$Rename
for(row_index in sequence(nrow(comparison_conversions))) {
	try({
		focal_field <- comparison_conversions$ColumnName[row_index]
		values_for_range <- as.numeric(focal_table[,focal_field])
		values_for_range <- values_for_range[is.finite(values_for_range)]
		focal_field_range <- range(values_for_range, na.rm=TRUE)
		focal_table[,focal_field] <- as.numeric(focal_table[,focal_field])
		table_to_plot <- focal_table[,colnames(focal_table) %in% c('UNITID Unique identification number of the institution', 'IPEDS Year','Comparison', focal_field, "Institution entity name")]
		colnames(table_to_plot)[grepl("IPEDS Year", colnames(table_to_plot))] <- "Year"
		table_to_plot <- table_to_plot[!is.na(table_to_plot[,focal_field]),]
		table_to_plot <- table_to_plot[order(table_to_plot$Year, decreasing=TRUE),]
		max_year <- Inf
		min_year <- 0
		table_to_plot_focal_only <- subset(table_to_plot, table_to_plot$Comparison=="Focal")
		comparison_df$Heading[row_index] <- comparison_conversions$Category[row_index]
		max_year <- max(table_to_plot_focal_only$Year)
		min_year <- min(table_to_plot_focal_only$Year)
		table_to_plot <- subset(table_to_plot, Year<=max_year & Year>=min_year)
		
		
		
		# Plot the focal measure
		suppressWarnings(suppressMessages({ # ggplot needs to talk way less
		
				
		plotting_data <- table_to_plot_focal_only
		colnames(plotting_data)[which(colnames(plotting_data)==focal_field)] <- "Number"
		plotting_data <- subset(plotting_data, !is.na(plotting_data$Number))
		plotting_data$NumberText <- paste0(sapply(plotting_data$Number, formatMe, digits=0))
		oldest <- plotting_data %>% slice(which.max(Year))
		youngest <- plotting_data %>% slice(which.min(Year))
		
		p <- ggplot(data=plotting_data, aes(x=Year, y=Number)) + 
				geom_link2(aes(colour = after_stat(ifelse(y > 0, "darkgray", "red")))) +
				scale_colour_manual(values=c("darkgray", "red")) +  geom_point(color="darkgray") +
				geom_text(data = youngest, aes(label = NumberText), vjust = "inward", hjust = "inward") +
			    geom_text(data = oldest, aes(label = NumberText), vjust = "inward", hjust = "inward") +
			  theme(axis.title=element_blank(),
				axis.text.y = element_blank(), 
				axis.ticks = element_blank(),
				strip.text = element_blank()) +
				theme(legend.position="none") 	
				
				#ylab("") + xlab("") + 
				#theme_minimal() + 
				#theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
				#scale_y_continuous(n.breaks=3) +
				#xlim(min_year, max_year) + 
				#theme(legend.position="none") 				
		#if(comparison_conversions$LogY[row_index]) {
			#p <- p + scale_y_continuous(trans = "log1p", limits=c(min(table_to_plot_focal_only[,focal_field], na.rm=TRUE), max(table_to_plot_focal_only[,focal_field], na.rm=TRUE)), breaks=round(c(min(table_to_plot_focal_only[,focal_field], na.rm=TRUE), max(table_to_plot_focal_only[,focal_field], na.rm=TRUE)),1))
		#	p <- p + scale_y_continuous(trans = "log1p")

		#} else {
			#p <- p + scale_y_continuous(limits=c(min(table_to_plot_focal_only[,focal_field], na.rm=TRUE), max(table_to_plot_focal_only[,focal_field], na.rm=TRUE)), breaks=round(c(min(table_to_plot_focal_only[,focal_field], na.rm=TRUE), max(table_to_plot_focal_only[,focal_field], na.rm=TRUE)),1))
		#	p <- p + scale_y_continuous()
		#}
		
		
		}))
		
		filename_png <- paste0("images/", utils::URLencode(gsub(" ", "", params$institution_name)), "_", row_index, ".png")

		suppressWarnings(suppressMessages({
			ggsave(
			plot = p,
			filename = paste0('docs/', filename_png),
			bg = "white",
			width = params$spark_width*2.5,
			height= params$spark_height*2.5,
			units = "px"
			)
		}))

		comparison_df$Change[row_index] <- paste0("<img src=", filename_png, " width=", spark_width, " height=", spark_height, ">")
		
		most_recent_value <- head(table_to_plot_focal_only[focal_field],1)
		original_most_recent_value <- most_recent_value
		if(comparison_conversions$Units[row_index]=="Dollars") {
			most_recent_value <- formatMe(most_recent_value, prefix="$")
		} else if(comparison_conversions$Units[row_index]=="Percent") {
			most_recent_value <- paste0(formatMe(most_recent_value), '%')
		} else {
			most_recent_value <- formatMe(most_recent_value)
		}
		most_recent_value <- paste0(most_recent_value, " (", max_year, ")")
		comparison_df[row_index,1] <- most_recent_value
			
		linear_fit_data <- table_to_plot_focal_only
		colnames(linear_fit_data)[which(colnames(linear_fit_data)==focal_field)] <- "Dependent"
		try({
		fit <- stats::lm(Dependent ~ Year, data=linear_fit_data)
		if(summary(fit)$coefficients[2,4]<0.05) { # a significant trend; not correcting for multiple comparisons, just getting an heuristic on changes over time
			change_symbol <- '↑'
			if(sign(summary(fit)$coefficients[2,1])<0) {
				change_symbol <- '↓'
			}
			slope <- summary(fit)$coefficients[2,1] 
			if(comparison_conversions$Units[row_index]=="Dollars") {
				slope <- paste0(ifelse(sign(slope)<0, "-", ""), '$', formatMe(abs(slope),0))
			} else if (comparison_conversions$Units[row_index]=="Percent") {
				slope <- paste0(abs(formatMe(slope,2)), '%')
			} else {
				slope <- formatMe(slope,0)
			}

			comparison_df$`Over time`[row_index] <- paste0(change_symbol, "<br />",  slope, ' per year')
		}
		}, silent=TRUE)
		
		
		# now for the stars
		star_symbol <- '⭐'
		if(comparison_conversions$Better[row_index]!="None") {
			for (grouping_index in sequence(length(comparison_vector))) {
				table_to_plot_comparison_only <- subset(table_to_plot, table_to_plot$Comparison==comparison_vector[grouping_index])
				comparison_values <- table_to_plot_comparison_only[which(table_to_plot_comparison_only$Year==max_year), focal_field]
				quantile_score <- stats::ecdf(comparison_values)(original_most_recent_value)
				if(comparison_conversions$Better[row_index]=="Lower") {
					quantile_score <- 1-quantile_score
				}
				star_string <- paste0(rep(star_symbol, max(1, ceiling(10*quantile_score/2))), collapse="") # there's always at least one star
				comparison_df[row_index, grouping_index+3] <- paste0(star_string, "<br />Better (", tolower(comparison_conversions$Better[row_index]), ") than ", round(100*quantile_score), '%')
			}
		}
		
	}, silent=TRUE)
}

comparison_df <- subset(comparison_df, nchar(comparison_df[,1])>0)

```




```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

# all categories based on how the US federal government bins people.
ethnicities <- c("American Indian or Alaska Native", "Asian", "Black or African American", "Hispanic or Latino", "Native Hawaiian or Other Pacific Islander", "White", "Two or more races", "Race ethnicity unknown", "Nonresident alien")
faculty_ranks <- c("Tenure-stream", "NTT-stream")
genders <- c("women", "men") 

faculty_ethnicity <- data.frame(matrix("", nrow=length(ethnicities), ncol=3))
rownames(faculty_ethnicity) <- ethnicities
colnames(faculty_ethnicity) <- c(params$institution_name, "Tenure track", "Non-tenure track")
for (rank_index in sequence(length(faculty_ranks))) {
	for (category_index in sequence(length(ethnicities))) {
		try({
			category_name <- paste0(faculty_ranks[rank_index], " ", ethnicities[category_index])
			ethnicity_df <- focal_focal[,colnames(focal_focal) %in% c('IPEDS Year', category_name, paste0(faculty_ranks[rank_index], " Grand total"))] 
			ethnicity_df$Year <- as.numeric(ethnicity_df$`IPEDS Year`)
			ethnicity_df$Percentage <- 100*ethnicity_df[,category_name]/ethnicity_df[,paste0(faculty_ranks[rank_index], " Grand total")]
			ethnicity_df <- subset(ethnicity_df, !is.na(ethnicity_df$Percentage))
			ethnicity_df$PercentageText <- paste0(sapply(ethnicity_df$Percentage, formatMe, digits=1),'%')
			oldest <- ethnicity_df %>% slice(which.max(Year))
			youngest <- ethnicity_df %>% slice(which.min(Year))
			p <- ggplot(ethnicity_df, aes(x=Year, y=Percentage)) + geom_line(color="gray") + geom_point(color="gray") +
			  geom_text(data = youngest, aes(label = PercentageText), vjust = "inward", hjust = "inward") +
			    geom_text(data = oldest, aes(label = PercentageText), vjust = "inward", hjust = "inward") +
			  theme(axis.title=element_blank(),
				axis.text.y = element_blank(), 
				axis.ticks = element_blank(),
				strip.text = element_blank())
			
			filename_png <- paste0("images/", utils::URLencode(gsub(" ", "", params$institution_name)), "_faculty_", category_index, "_", rank_index, ".png")
			
			suppressWarnings(suppressMessages({
				ggsave(
				plot = p,
				filename = paste0('docs/', filename_png),
				bg = "transparent",
				width = params$spark_width*2.5,
				height= params$spark_height*2.5,
				units = "px"
				)
			}))
			
			

			faculty_ethnicity[category_index, rank_index+1] <- paste0("<img src=", filename_png, " width=400 height=100>")
		})
	}
}



```


<a href='`r PrependHttpsIfNeeded(most_current_info['Institution s internet website address'])`'>`r most_current_info['Institution entity name']`</a> is located in `r most_current_info['City location of institution']`, `r most_current_info['State abbreviation']`. It is a `r tolower(most_current_info['Sector of institution'])` institution. Carnegie classifies it overall as being among "`r most_current_info['Carnegie Classification 2021 Basic']`" institutions, with its undergraduate program "`r most_current_info['Carnegie Classification 2021 Undergraduate Instructional Program']`" and graduate program "`r most_current_info['Carnegie Classification 2021 Graduate Instructional Program']`". 


# Enrollment


```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}
	pretty_table <- comparison_df[which(comparison_df$Heading == "Enrollment"),]
	pretty_table %>% dplyr::select(-c(Heading)) %>% knitr::kable(align="c")
```

# Student financing


```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}
	pretty_table <- comparison_df[which(comparison_df$Heading == "Student financing"),]
	pretty_table %>% dplyr::select(-c(Heading)) %>% knitr::kable(align="c")
```

# Teaching

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}
	pretty_table <- comparison_df[which(comparison_df$Heading == "Teaching"),]
	pretty_table %>% dplyr::select(-c(Heading)) %>% knitr::kable(align="c")
```

# Institution finances

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}
	pretty_table <- comparison_df[which(comparison_df$Heading == "Institution finances"),]
	pretty_table %>% dplyr::select(-c(Heading)) %>% knitr::kable(align="c")
```

# Library facilities


```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}
	pretty_table <- comparison_df[which(comparison_df$Heading == "Library facilities"),]
	pretty_table %>% dplyr::select(-c(Heading)) %>% knitr::kable(align="c")
```

# SAT scores

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}
	pretty_table <- comparison_df[which(comparison_df$Heading == "SAT scores"),]
	pretty_table %>% dplyr::select(-c(Heading)) %>% knitr::kable(align="c")
```

# ACT scores

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}
	pretty_table <- comparison_df[which(comparison_df$Heading == "ACT scores"),]
	pretty_table %>% dplyr::select(-c(Heading)) %>% knitr::kable(align="c")
```

# Faculty ethnicity/race

This uses categories from the US federal data.

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}
	faculty_ethnicity %>% knitr::kable(align="c")
```